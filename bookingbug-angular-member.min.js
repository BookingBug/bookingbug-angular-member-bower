"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}angular.module("BBMember",["BB","BBMember.Directives","BBMember.Services","BBMember.Filters","BBMember.Controllers","BBMember.Models","trNgGrid","pascalprecht.translate"]),angular.module("BBMember.Directives",[]),angular.module("BBMember.Filters",[]),angular.module("BBMember.Models",[]),angular.module("BBMember.Services",["ngResource","ngSanitize"]),angular.module("BBMember.Controllers",["ngSanitize"]),angular.module("BBMemberMockE2E",["BBMember","BBAdminMockE2E"]),angular.module("BBMember").config(function($logProvider){"ngInject";$logProvider.debugEnabled(!0)}),angular.module("BBMember").run(function($q,$injector,BBModel){"ngInject";var models=["Member","Booking","Wallet","WalletLog","Purchase","PurchaseItem","WalletPurchaseBand","PaymentItem"],mfuncs={},_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(models)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var model=_step.value;mfuncs[model]=$injector.get("Member."+model+"Model")}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}BBModel.Member=mfuncs}),angular.module("BBMember").controller("MemberBookings",function($scope,$uibModal,$document,$log,$q,ModalForm,$rootScope,AlertService,PurchaseService,LoadingService,BBModel){var loader=LoadingService.$loader($scope);$scope.getUpcomingBookings=function(){var defer=$q.defer(),now=moment(),params={start_date:now.toISODate()};return getBookings(params).then(function(results){return $scope.upcoming_bookings=_.filter(results,function(result){return result.datetime.isAfter(now)}),defer.resolve($scope.upcoming_bookings)},function(err){return defer.reject([])}),defer.promise},$scope.getPastBookings=function(num,type){var date=void 0,defer=$q.defer();date=num&&type?moment().subtract(num,type):moment().subtract(1,"year");var params={start_date:date.format("YYYY-MM-DD"),end_date:moment().add(1,"day").format("YYYY-MM-DD")};return getBookings(params).then(function(past_bookings){return $scope.past_bookings=_.chain(past_bookings).filter(function(b){return b.datetime.isBefore(moment())}).sortBy(function(b){return-b.datetime.unix()}).value(),defer.resolve(past_bookings)},function(err){return defer.reject([])}),defer.promise},$scope.flushBookings=function(){var params={start_date:moment().format("YYYY-MM-DD")};return $scope.member.$flush("bookings",params)};var updateBookings=function(){return $scope.getUpcomingBookings()},getBookings=function(params){loader.notLoaded();var defer=$q.defer();return $scope.member.getBookings(params).then(function(bookings){return loader.setLoaded(),defer.resolve(bookings)},function(err){return $log.error(err.data),loader.setLoaded()}),defer.promise};$scope.cancelBooking=function(booking){var index=_.indexOf($scope.upcoming_bookings,booking);return _.without($scope.upcoming_bookings,booking),BBModel.Member.Booking.$cancel($scope.member,booking).then(function(){if(AlertService.raise("BOOKING_CANCELLED"),$rootScope.$broadcast("booking:cancelled"),$scope.removeBooking)return $scope.removeBooking(booking)},function(err){return AlertService.raise("GENERIC"),$scope.upcoming_bookings.splice(index,0,booking)})},$scope.getPrePaidBookings=function(params){var defer=$q.defer();return $scope.member.$getPrePaidBookings(params).then(function(bookings){return $scope.pre_paid_bookings=bookings,defer.resolve(bookings)},function(err){return defer.reject([]),$log.error(err.data)}),defer.promise};var bookWaitlistSucces=function(){return AlertService.raise("WAITLIST_ACCEPTED"),updateBookings()},openPaymentModal=function(_booking,_total){var modalInstance=$uibModal.open({templateUrl:"booking_payment_modal.html",windowClass:"bbug",size:"lg",controller:function($scope,$uibModalInstance,booking,total){return $scope.booking=booking,$scope.total=total,$scope.handlePaymentSuccess=function(){return $uibModalInstance.close(booking)},$scope.cancel=function(){return $uibModalInstance.dismiss("cancel")}},resolve:{booking:function(){return _booking},total:function(){return _total}}});return modalInstance.result.then(function(booking){return bookWaitlistSucces()})};return{edit:function(booking){return booking.$getAnswers().then(function(answers){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(answers.answers)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var answer=_step.value;booking["question"+answer.question_id]=answer.value}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return ModalForm.edit({model:booking,title:"Booking Details",templateUrl:"edit_booking_modal_form.html",windowClass:"member_edit_booking_form",success:updateBookings})})},cancel:function(_booking2){var modalInstance=$uibModal.open({templateUrl:"member_booking_delete_modal.html",windowClass:"bbug",controller:function($scope,$rootScope,$uibModalInstance,booking){return $scope.booking=booking,$scope.confirm_delete=function(){return $uibModalInstance.close(booking)},$scope.cancel=function(){return $uibModalInstance.dismiss("cancel")}},resolve:{booking:function(){return _booking2}}});return modalInstance.result.then(function(booking){return $scope.cancelBooking(booking)})},book:function(booking){loader.notLoaded();var params={purchase_id:booking.purchase_ref,url_root:$rootScope.bb.api_url,booking:booking};return PurchaseService.bookWaitlistItem(params).then(function(purchase_total){return purchase_total.due_now>0?purchase_total.$has("new_payment")?openPaymentModal(booking,purchase_total):$log.error("total is missing new_payment link, this is usually caused by online payment not being configured correctly"):bookWaitlistSucces()},function(err){return AlertService.raise("NO_WAITLIST_SPACES_LEFT")}),loader.setLoaded()},pay:function(booking){var params={url_root:$scope.$root.bb.api_url,purchase_id:booking.purchase_ref};return PurchaseService.query(params).then(function(total){return openPaymentModal(booking,total)})}}}),angular.module("BBMember").controller("MemberPurchases",function($scope,$q,$log,LoadingService,BBModel){return $scope.getPurchases=function(){var loader=LoadingService.$loader($scope).notLoaded(),defer=$q.defer();return BBModel.Member.Purchase.$query($scope.member,{}).then(function(purchases){return $scope.purchases=purchases,loader.setLoaded(),defer.resolve(purchases)},function(err){return $log.error(err.data),loader.setLoaded(),defer.reject([])}),defer.promise}}),angular.module("BBMember").controller("Wallet",function($scope,$rootScope,$q,$log,AlertService,LoadingService,BBModel){var updateClient=void 0,loader=LoadingService.$loader($scope);return $scope.getWalletForMember=function(member,params){var defer=$q.defer();return loader.notLoaded(),BBModel.Member.Wallet.$getWalletForMember(member,params).then(function(wallet){return loader.setLoaded(),$scope.wallet=wallet,updateClient(wallet),defer.resolve(wallet)},function(err){return loader.setLoaded(),defer.reject()}),defer.promise},$scope.getWalletLogs=function(){var defer=$q.defer();return loader.notLoaded(),BBModel.Member.Wallet.$getWalletLogs($scope.wallet).then(function(logs){return logs=_.sortBy(logs,function(log){return-moment(log.created_at).unix()}),loader.setLoaded(),$scope.logs=logs,defer.resolve(logs)},function(err){return loader.setLoaded(),$log.error(err.data),defer.reject([])}),defer.promise},$scope.getWalletPurchaseBandsForWallet=function(wallet){var defer=$q.defer();return loader.notLoaded(),BBModel.Member.Wallet.$getWalletPurchaseBandsForWallet(wallet).then(function(bands){return $scope.bands=bands,loader.setLoaded(),defer.resolve(bands)},function(err){return loader.setLoaded(),$log.error(err.data),defer.resolve([])}),defer.promise},$scope.createWalletForMember=function(member){return loader.notLoaded(),BBModel.Member.Wallet.$createWalletForMember(member).then(function(wallet){return loader.setLoaded(),$scope.wallet=wallet},function(err){return loader.setLoaded(),$log.error(err.data)})},$scope.updateWallet=function(member,amount,band){if(null==band&&(band=null),loader.notLoaded(),member){var params={};return amount>0&&(params.amount=amount),$scope.wallet&&(params.wallet_id=$scope.wallet.id),$scope.total&&(params.total_id=$scope.total.id),$scope.deposit&&(params.deposit=$scope.deposit),$scope.basket&&(params.basket_total_price=$scope.basket.total_price),band&&(params.band_id=band.id),BBModel.Member.Wallet.$updateWalletForMember(member,params).then(function(wallet){return loader.setLoaded(),$scope.wallet=wallet,$rootScope.$broadcast("wallet:updated",wallet,band)},function(err){return loader.setLoaded(),$log.error(err.data)})}},$scope.activateWallet=function(member){if(loader.notLoaded(),member){var params={status:1};return $scope.wallet&&(params.wallet_id=$scope.wallet.id),BBModel.Member.Wallet.$updateWalletForMember(member,params).then(function(wallet){return loader.setLoaded(),$scope.wallet=wallet},function(err){return loader.setLoaded(),$log.error(err.date)})}},$scope.deactivateWallet=function(member){if(loader.notLoaded(),member){var params={status:0};return $scope.wallet&&(params.wallet_id=$scope.wallet.id),BBModel.Member.Wallet.$updateWalletForMember(member,params).then(function(wallet){return loader.setLoaded(),$scope.wallet=wallet},function(err){return loader.setLoaded(),$log.error(err.date)})}},$scope.purchaseBand=function(band){return $scope.selected_band=band,$scope.updateWallet($scope.member,band.wallet_amount,band)},$scope.walletPaymentDone=function(){return $scope.getWalletForMember($scope.member).then(function(wallet){return AlertService.raise("TOPUP_SUCCESS"),$rootScope.$broadcast("wallet:topped_up",wallet),$scope.wallet_topped_up=!0})},$scope.basketWalletPaymentDone=function(){return $scope.callSetLoaded(),$scope.decideNextPage("checkout")},$scope.error=function(message){return AlertService.warning("TOPUP_FAILED")},$scope.add=function(value){return value=value||$scope.amount_increment,$scope.amount+=value},$scope.subtract=function(value){return value=value||$scope.amount_increment,$scope.add(-value)},$scope.isSubtractValid=function(value){if(!$scope.wallet)return!1;value=value||$scope.amount_increment;var new_amount=$scope.amount-value;return new_amount>=$scope.wallet.min_amount},updateClient=function(wallet){if($scope.member.self===$scope.client.self)return $scope.client.wallet_amount=wallet.amount}}),angular.module("BBMember").directive("bbMemberBooking",function(){return{templateUrl:"_member_booking.html",scope:{booking:"=bbMemberBooking"},require:["^?bbMemberUpcomingBookings","^?bbMemberPastBookings"],link:function(scope,element,attrs,controllers){scope.actions=[];var member_booking_controller=controllers[0]?controllers[0]:controllers[1],time_now=moment();if(scope.booking.on_waitlist&&!scope.booking.datetime.isBefore(time_now,"day")&&scope.actions.push({action:member_booking_controller.book,label:"Book",translation_key:"MEMBER_BOOKING_WAITLIST_ACCEPT",disabled:!scope.booking.settings.sent_waitlist}),scope.booking.paid<scope.booking.price&&scope.booking.datetime.isAfter(time_now)&&scope.actions.push({action:member_booking_controller.pay,label:"Pay"}),scope.actions.push({action:member_booking_controller.edit,label:"Details",translation_key:"MEMBER_BOOKING_EDIT"}),!scope.booking.datetime.isBefore(time_now,"day"))return scope.actions.push({action:member_booking_controller.cancel,label:"Cancel",translation_key:"MEMBER_BOOKING_CANCEL"})}}}),angular.module("BBMember").directive("memberBookings",function($rootScope){return{templateUrl:"member_bookings_tabs.html",scope:{member:"="},link:function(scope,element,attrs){}}}),angular.module("BBMember").directive("memberBookingsTable",function($uibModal,$log,ModalForm,BBModel){var controller=function($scope,$uibModal,$document){$scope.loading=!0,$scope.fields||($scope.fields=["date_order","details"]),$scope.$watch("member",function(member){if(null!=member)return getBookings($scope,member)}),$scope.edit=function(id){var booking=_.find($scope.booking_models,function(b){return b.id===id});return booking.$getAnswers().then(function(answers){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(answers.answers)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var answer=_step.value;booking["question"+answer.question_id]=answer.value}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return ModalForm.edit({model:booking,title:"Booking Details",templateUrl:"edit_booking_modal_form.html",success:function(b){b=new BBModel.Member.Booking(b);var i=_.indexOf($scope.booking_models,function(b){return b.id===id});return $scope.booking_models[i]=b,$scope.setRows()}})})},$scope.cancel=function(id){var _booking=_.find($scope.booking_models,function(b){return b.id===id}),modalInstance=$uibModal.open({templateUrl:"member_bookings_table_cancel_booking.html",controller:function($scope,$uibModalInstance,booking){return $scope.booking=booking,$scope.booking.notify=!0,$scope.ok=function(){return $uibModalInstance.close($scope.booking)},$scope.close=function(){return $uibModalInstance.dismiss()}},scope:$scope,resolve:{booking:function(){return _booking}}});return modalInstance.result.then(function(booking){$scope.loading=!0;var params={notify:booking.notify};return booking.$post("cancel",params).then(function(){var i=_.findIndex($scope.booking_models,function(b){return b.id===booking.id});return $scope.booking_models.splice(i,1),$scope.setRows(),$scope.loading=!1})})},$scope.setRows=function(){return $scope.bookings=_.map($scope.booking_models,function(booking){return{id:booking.id,date:moment(booking.datetime).format("YYYY-MM-DD"),date_order:moment(booking.datetime).format("x"),datetime:moment(booking.datetime),details:booking.full_describe}})};var getBookings=function($scope,member){var params={src:member,start_date:$scope.startDate.format("YYYY-MM-DD"),start_time:$scope.startTime?$scope.startTime.format("HH:mm"):void 0,end_date:$scope.endDate?$scope.endDate.format("YYYY-MM-DD"):void 0,end_time:$scope.endTime?$scope.endTime.format("HH:mm"):void 0};return BBModel.Member.Booking.$query(member,params).then(function(bookings){var now=moment.unix();return $scope.period&&"past"===$scope.period&&($scope.booking_models=_.filter(bookings.items,function(x){return x.datetime.unix()<now})),$scope.period&&"future"===$scope.period?$scope.booking_models=_.filter(bookings.items,function(x){return x.datetime.unix()>now}):$scope.booking_models=bookings.items,$scope.setRows(),$scope.loading=!1},function(err){return $log.error(err.data),$scope.loading=!1})};if($scope.startDate||($scope.startDate=moment()),$scope.orderBy=$scope.defaultOrder,null==$scope.orderBy&&($scope.orderBy="date_order"),$scope.now=moment(),$scope.member)return getBookings($scope,$scope.member)};return{controller:controller,templateUrl:"member_bookings_table.html",scope:{apiUrl:"@",fields:"=?",member:"=",startDate:"=?",startTime:"=?",endDate:"=?",endTime:"=?",defaultOrder:"=?",period:"=?"}}}),angular.module("BBMember").directive("memberForm",function($rootScope,AlertService,PathSvc){return{templateUrl:function(el,attrs){return null!=attrs.bbCustomMemberForm?PathSvc.directivePartial("_member_form"):PathSvc.directivePartial("_member_schema_form")},scope:{apiUrl:"@",member:"=",onSuccessSave:"=",onFailSave:"=",onValidationError:"="},link:function(scope,element,attrs){if($rootScope.bb||($rootScope.bb={}),$rootScope.bb.api_url||($rootScope.bb.api_url=attrs.apiUrl),$rootScope.bb.api_url||($rootScope.bb.api_url="http://www.bookingbug.com"),null!=attrs.bbCustomMemberForm)return scope.custom_member_form=!0},controller:function($scope,FormTransform){$scope.loading=!0;var checkSchema=function(schema){for(var k in schema.properties){var v=schema.properties[k],vals=k.split(".");"questions"===vals[0]&&vals.length>1&&(schema.properties.questions||(schema.properties.questions={type:"object",properties:{}}),schema.properties.questions.properties[vals[1]]||(schema.properties.questions.properties[vals[1]]={type:"object",properties:{answer:v}})),"client"===vals[0]&&vals.length>2&&(schema.properties.client||(schema.properties.client={type:"object",properties:{q:{type:"object",properties:{}}}}),schema.properties.client.properties&&(schema.properties.client.properties.q.properties[vals[2]]||(schema.properties.client.properties.q.properties[vals[2]]={type:"object",properties:{answer:v}})))}return schema};$scope.$watch("member",function(member){if(null!=member){if(member.$has("edit_member"))return member.$get("edit_member").then(function(member_schema){$scope.form=member_schema.form;var model_type=functionName(member.constructor);return FormTransform.edit[model_type]&&($scope.form=FormTransform.edit[model_type]($scope.form,member_schema.schema,member)),$scope.schema=checkSchema(member_schema.schema),$scope.loading=!1});if(member.$has("edit"))return member.$get("edit").then(function(member_schema){$scope.form=member_schema.form;var model_type=functionName(member.constructor);return FormTransform.edit[model_type]&&($scope.form=FormTransform.edit[model_type]($scope.form,member_schema.schema,member)),$scope.schema=checkSchema(member_schema.schema),$scope.loading=!1})}});var functionName=function(func){var result=/^function\s+([\w\$]+)\s*\(/.exec(func.toString());return result?result[1]:""};return $scope.submit=function(form,data){if($scope.$broadcast("schemaFormValidate"),form.$valid){if($scope.loading=!0,!$scope.custom_member_form){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(data.questions)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var item=_step.value;item.answer=data.q[item.id].answer}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}return $scope.member.$put("self",{},data).then(function(member){if($scope.loading=!1,AlertService.raise("UPDATE_SUCCESS"),"function"==typeof $scope.onSuccessSave)return $scope.onSuccessSave()},function(err){if($scope.loading=!1,AlertService.raise("UPDATE_FAILED"),"function"==typeof $scope.onFailSave)return $scope.onFailSave()})}if("function"==typeof $scope.onValidationError)return $scope.onValidationError()}}}}),angular.module("BBMember").directive("loginMember",function($uibModal,$document,$log,$rootScope,MemberLoginService,$templateCache,$q,$sessionStorage,halClient){var loginMemberController=function($scope,$uibModalInstance,company_id){return $scope.title="Login",$scope.schema={type:"object",properties:{email:{type:"string",title:"Email"},password:{type:"string",title:"Password"}}},$scope.form=[{key:"email",type:"email",feedback:!1,autofocus:!0},{key:"password",type:"password",feedback:!1}],$scope.login_form={},$scope.submit=function(form){var options={company_id:company_id};return MemberLoginService.login(form,options).then(function(member){return member.email=form.email,member.password=form.password,$uibModalInstance.close(member)},function(err){return $uibModalInstance.dismiss(err)})},$scope.cancel=function(){return $uibModalInstance.dismiss("cancel")}},pickCompanyController=function($scope,$uibModalInstance,companies){var c=void 0;return $scope.title="Pick Company",$scope.schema={type:"object",properties:{company_id:{type:"integer",title:"Company"}}},$scope.schema.properties.company_id.enum=function(){var result=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(companies)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0)c=_step.value,result.push(c.id)}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return result}(),$scope.form=[{key:"company_id",type:"select",titleMap:function(){var result1=[],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(companies)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0)c=_step2.value,result1.push({value:c.id,name:c.name})}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return result1}(),autofocus:!0}],$scope.pick_company_form={},$scope.submit=function(form){return $uibModalInstance.close(form.company_id)},$scope.cancel=function(){return $uibModalInstance.dismiss("cancel")}},link=function(scope,element,attrs){$rootScope.bb||($rootScope.bb={}),$rootScope.bb.api_url||($rootScope.bb.api_url=scope.apiUrl),$rootScope.bb.api_url||($rootScope.bb.api_url="http://www.bookingbug.com");var loginModal=function loginModal(){var modalInstance=$uibModal.open({templateUrl:"login_modal_form.html",controller:loginMemberController,resolve:{company_id:function(){return scope.companyId}}});return modalInstance.result.then(function(result){return scope.memberEmail=result.email,scope.memberPassword=result.password,result.$has("members")?result.$get("members").then(function(members){return scope.members=members,$q.all(Array.from(members).map(function(m){return m.$get("company")})).then(function(companies){return pickCompanyModal(companies)})}):scope.member=result},function(){return loginModal()})},pickCompanyModal=function pickCompanyModal(_companies){var modalInstance=$uibModal.open({templateUrl:"pick_company_modal_form.html",controller:pickCompanyController,resolve:{companies:function(){return _companies}}});return modalInstance.result.then(function(company_id){return scope.companyId=company_id,tryLogin()},function(){return pickCompanyModal()})},tryLogin=function(){var login_form={email:scope.memberEmail,password:scope.memberPassword},options={company_id:scope.companyId};return MemberLoginService.login(login_form,options).then(function(result){return result.$has("members")?result.$get("members").then(function(members){return scope.members=members,$q.all(Array.from(members).map(function(m){return m.$get("company")})).then(function(companies){return pickCompanyModal(companies)})}):scope.member=result},function(err){return loginModal()})};if(scope.memberEmail&&scope.memberPassword)return tryLogin();if($sessionStorage.getItem("login")){var session_member=$sessionStorage.getItem("login");return session_member=halClient.createResource(session_member),scope.member=session_member}return loginModal()};return{link:link,scope:{memberEmail:"@",memberPassword:"@",companyId:"@",apiUrl:"@",member:"="},transclude:!0,template:"<div ng-show='member' ng-transclude></div>"}}),angular.module("BBMember").directive("bbMemberPastBookings",function($rootScope,PaginationService){return{templateUrl:"member_past_bookings.html",scope:{member:"=",notLoaded:"=",setLoaded:"="},controller:"MemberBookings",link:function(scope,element,attrs){scope.pagination=PaginationService.initialise({page_size:10,max_size:5});var getBookings=function(){return scope.getPastBookings().then(function(past_bookings){if(past_bookings)return PaginationService.update(scope.pagination,past_bookings.length)})};if(scope.$watch("member",function(){if(scope.member&&!scope.past_bookings)return getBookings()}),scope.member)return getBookings()}}}),angular.module("BBMember").directive("bbMemberPrePaidBookings",function($rootScope,PaginationService){return{templateUrl:"member_pre_paid_bookings.html",scope:{member:"="},controller:"MemberBookings",link:function(scope,element,attrs){scope.pagination=PaginationService.initialise({page_size:10,max_size:5});var getBookings=function(){return scope.getPrePaidBookings({}).then(function(pre_paid_bookings){return PaginationService.update(scope.pagination,pre_paid_bookings.length)})};if(scope.$watch("member",function(){if(!scope.pre_paid_bookings)return getBookings()}),scope.$on("booking:cancelled",function(event){return scope.getPrePaidBookings({}).then(function(pre_paid_bookings){return PaginationService.update(scope.pagination,pre_paid_bookings.length)})}),scope.member)return getBookings()}}}),angular.module("BBMember").directive("bbMemberPurchases",function($rootScope,PaginationService){return{templateUrl:"member_purchases.html",scope:!0,controller:"MemberPurchases",
link:function(scope,element,attrs){return scope.member=scope.$eval(attrs.member),$rootScope.member&&(scope.member||(scope.member=$rootScope.member)),scope.pagination=PaginationService.initialise({page_size:10,max_size:5}),$rootScope.connection_started.then(function(){if(scope.member)return scope.getPurchases().then(function(purchases){return PaginationService.update(scope.pagination,purchases.length)})})}}}),angular.module("BBMember").directive("memberSsoLogin",function($rootScope,LoginService,$sniffer,$timeout,QueryStringService){return{scope:{token:"@memberSsoLogin",company_id:"@companyId"},transclude:!0,template:"<div ng-if='member' ng-transclude></div>",link:function(scope,element,attrs){var options={root:$rootScope.bb.api_url,company_id:scope.company_id},data={};return scope.token&&(data.token=scope.token),data.token||(data.token=QueryStringService("sso_token")),$sniffer.msie&&$sniffer.msie<10&&$rootScope.iframe_proxy_ready===!1?$timeout(function(){return LoginService.ssoLogin(options,data).then(function(member){return scope.member=member})},2e3):LoginService.ssoLogin(options,data).then(function(member){return scope.member=member})}}}),angular.module("BBMember").directive("bbMemberUpcomingBookings",function($rootScope,PaginationService,PurchaseService){return{templateUrl:"member_upcoming_bookings.html",scope:{member:"=",notLoaded:"=",setLoaded:"="},controller:"MemberBookings",link:function(scope,element,attrs){scope.pagination=PaginationService.initialise({page_size:10,max_size:5});var getBookings=function(){return scope.getUpcomingBookings().then(function(upcoming_bookings){return PaginationService.update(scope.pagination,upcoming_bookings.length)})};return scope.$on("updateBookings",function(){return scope.flushBookings(),getBookings()}),scope.$watch("member",function(){if(!scope.upcoming_bookings)return getBookings()}),$rootScope.connection_started.then(function(){return getBookings()})}}}),angular.module("BBMember").directive("bbWallet",function($rootScope){return{scope:!0,controller:"Wallet",templateUrl:"wallet.html",link:function(scope,element,attrs){return scope.member=scope.$eval(attrs.member),$rootScope.member&&(scope.member||(scope.member=$rootScope.member)),scope.show_wallet_logs=!0,scope.show_topup_box=!1,$rootScope.connection_started.then(function(){if(scope.member)return scope.getWalletForMember(scope.member)}),scope.$on("wallet:topped_up",function(event,wallet){return scope.wallet=wallet,scope.show_topup_box=!1,scope.show_wallet_logs=!0}),scope.$on("booking:cancelled",function(event){if(scope.member)return scope.getWalletForMember(scope.member)})}}}),angular.module("BBMember").directive("bbWalletLogs",function($rootScope,PaginationService){return{templateUrl:"wallet_logs.html",scope:!0,controller:"Wallet",require:"^?bbWallet",link:function(scope,element,attrs,ctrl){scope.member=scope.$eval(attrs.member),$rootScope.member&&(scope.member||(scope.member=$rootScope.member)),scope.pagination=PaginationService.initialise({page_size:10,max_size:5});var getWalletLogs=function(){return scope.getWalletLogs().then(function(logs){return PaginationService.update(scope.pagination,logs.length)})};return scope.$on("wallet:topped_up",function(event){return getWalletLogs()}),$rootScope.connection_started.then(function(){if(ctrl){var deregisterWatch=void 0;return deregisterWatch=scope.$watch("wallet",function(){if(scope.wallet)return getWalletLogs(),deregisterWatch()})}return scope.getWalletForMember(scope.member).then(function(){return getWalletLogs()})})}}}),angular.module("BB.Directives").directive("bbWalletPayment",function($sce,$rootScope,$window,$location,GeneralOptions,AlertService){return{restrict:"A",controller:"Wallet",scope:!0,replace:!0,require:"^?bbWallet",link:function(scope,element,attrs,ctrl){var one_pound=100;scope.wallet_payment_options=scope.$eval(attrs.bbWalletPayment)||{},scope.member=scope.$eval(attrs.member),$rootScope.member&&(scope.member||(scope.member=$rootScope.member)),scope.wallet_payment_options.member&&(scope.member||(scope.member=scope.wallet_payment_options.member)),scope.amount_increment=scope.wallet_payment_options.amount_increment||one_pound;var getHost=function(url){var a=document.createElement("a");return a.href=url,a.protocol+"//"+a.host},sendLoadEvent=function(element,origin,scope){var referrer=$location.protocol()+"://"+$location.host();$location.port()&&(referrer+=":"+$location.port());var custom_stylesheet=scope.wallet_payment_options.custom_stylesheet?scope.wallet_payment_options.custom_stylesheet:null,custom_partial_url=scope.bb&&scope.bb.custom_partial_url?scope.bb.custom_partial_url:null,payload=JSON.stringify({type:"load",message:referrer,custom_partial_url:custom_partial_url,custom_stylesheet:custom_stylesheet,scroll_offset:GeneralOptions.scroll_offset});return element.find("iframe")[0].contentWindow.postMessage(payload,origin)},calculateAmount=function(){if(scope.wallet_payment_options.basket_topup){var amount_due=scope.bb.basket.dueTotal()-scope.wallet.amount;return amount_due>scope.wallet.min_amount?scope.amount=Math.ceil(amount_due/scope.amount_increment)*scope.amount_increment:scope.amount=scope.wallet.min_amount,scope.min_amount=scope.amount}return scope.wallet.min_amount?(scope.amount=scope.wallet_payment_options.amount&&scope.wallet_payment_options.amount>scope.wallet.min_amount?scope.wallet_payment_options.amount:scope.wallet.min_amount,scope.min_amount=scope.wallet.min_amount):(scope.min_amount=0,scope.wallet_payment_options.amount?scope.amount=scope.wallet_payment_options.amount:void 0)};return $rootScope.connection_started.then(function(){if(ctrl){var deregisterWatch=void 0;return deregisterWatch=scope.$watch("wallet",function(){if(scope.wallet)return calculateAmount(),deregisterWatch()})}return scope.getWalletForMember(scope.member).then(function(){return calculateAmount()})}),scope.$on("wallet:updated",function(event,wallet,band){if(null==band&&(band=null),wallet.$has("new_payment"))return scope.notLoaded(scope),band&&(scope.amount=band.actual_amount),scope.wallet_payment_url=$sce.trustAsResourceUrl(wallet.$href("new_payment")),scope.show_payment_iframe=!0,element.find("iframe").bind("load",function(event){var url=void 0;scope.wallet_payment_url&&(url=scope.wallet_payment_url);var origin=getHost(url);return sendLoadEvent(element,origin,scope),scope.$apply(function(){return scope.setLoaded(scope)})})}),$window.addEventListener("message",function(event){var data=void 0;return angular.isObject(event.data)?data=event.data:event.data.match(/iFrameSizer/)||(data=JSON.parse(event.data)),scope.$apply(function(){if(data)switch(data.type){case"submitting":return scope.notLoaded(scope);case"error":return $rootScope.$broadcast("wallet:topup_failed"),scope.notLoaded(scope),document.getElementsByTagName("iframe")[0].src+="",AlertService.raise("PAYMENT_FAILED");case"payment_complete":case"wallet_payment_complete":case"basket_wallet_payment_complete":return scope.show_payment_iframe=!1,scope.wallet_payment_options.basket_topup?scope.basketWalletPaymentDone():scope.walletPaymentDone()}})},!1)}}}),angular.module("BB.Directives").directive("bbWalletPurchaseBands",function($rootScope){return{scope:!0,restrict:"AE",templateUrl:"wallet_purchase_bands.html",controller:"Wallet",require:"^?bbWallet",link:function(scope,attr,elem,ctrl){return scope.member=scope.$eval(attr.member),$rootScope.member&&(scope.member||(scope.member=$rootScope.member)),$rootScope.connection_started.then(function(){if(ctrl){var deregisterWatch=void 0;return deregisterWatch=scope.$watch("wallet",function(){if(scope.wallet)return scope.getWalletPurchaseBandsForWallet(scope.wallet),deregisterWatch()})}return scope.getWalletForMember(scope.member).then(function(){return scope.getWalletPurchaseBandsForWallet(scope.wallet)})})}}});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();angular.module("BB.Models").factory("Member.BookingModel",function($q,$window,$bbug,MemberBookingService,BBModel,BaseModel){return function(_BaseModel){function Member_Booking(data){_classCallCheck(this,Member_Booking);var _this=_possibleConstructorReturn(this,(Member_Booking.__proto__||Object.getPrototypeOf(Member_Booking)).call(this,data));return _this.datetime=moment.parseZone(_this.datetime),_this.time_zone&&_this.datetime.tz(_this.time_zone),_this.end_datetime=moment.parseZone(_this.end_datetime),_this.time_zone&&_this.end_datetime.tz(_this.time_zone),_this.min_cancellation_time=moment(_this.min_cancellation_time),_this.min_cancellation_hours=_this.datetime.diff(_this.min_cancellation_time,"hours"),_this}return _inherits(Member_Booking,_BaseModel),_createClass(Member_Booking,[{key:"icalLink",value:function(){return this._data.$href("ical")}},{key:"webcalLink",value:function(){return this._data.$href("ical")}},{key:"gcalLink",value:function(){return this._data.$href("gcal")}},{key:"getGroup",value:function(){var _this2=this;return this.group?this.group:this._data.$has("event_groups")?this._data.$get("event_groups").then(function(group){return _this2.group=group,_this2.group}):void 0}},{key:"getColour",value:function(){return this.getGroup()?this.getGroup().colour:"#FFFFFF"}},{key:"getCompany",value:function(){var _this3=this;return this.company?this.company:this.$has("company")?this._data.$get("company").then(function(company){return _this3.company=new BBModel.Company(company),_this3.company}):void 0}},{key:"getAnswers",value:function(){var _this4=this,defer=$q.defer();return this.answers&&defer.resolve(this.answers),this._data.$has("answers")?this._data.$get("answers").then(function(answers){return _this4.answers=Array.from(answers).map(function(a){return new BBModel.Answer(a)}),defer.resolve(_this4.answers)}):defer.resolve([]),defer.promise}},{key:"printed_price",value:function(){return parseFloat(this.price)%1===0?"£"+this.price:$window.sprintf("£%.2f",parseFloat(this.price))}},{key:"$getMember",value:function(){var _this5=this,defer=$q.defer();return this.member&&defer.resolve(this.member),this._data.$has("member")&&this._data.$get("member").then(function(member){return _this5.member=new BBModel.Member.Member(member),defer.resolve(_this5.member)}),defer.promise}},{key:"canCancel",value:function(){return moment(this.min_cancellation_time).isAfter(moment())}},{key:"canMove",value:function(){return this.canCancel()}},{key:"$update",value:function(){return MemberBookingService.update(this)}}],[{key:"$query",value:function(member,params){return MemberBookingService.query(member,params)}},{key:"$cancel",value:function(member,booking){return MemberBookingService.cancel(member,booking)}},{key:"$update",value:function(booking){return MemberBookingService.update(booking)}},{key:"$flush",value:function(member,params){return MemberBookingService.flush(member,params)}}]),Member_Booking}(BaseModel)});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();angular.module("BB.Models").factory("Member.MemberModel",function($q,MemberService,BBModel,BaseModel,ClientModel){return function(_ClientModel){function Member_Member(){return _classCallCheck(this,Member_Member),_possibleConstructorReturn(this,(Member_Member.__proto__||Object.getPrototypeOf(Member_Member)).apply(this,arguments))}return _inherits(Member_Member,_ClientModel),_createClass(Member_Member,[{key:"getBookings",value:function(params){return BBModel.Member.Booking.$query(this,params)}}],[{key:"$refresh",value:function(member){return MemberService.refresh(member)}},{key:"$current",value:function(){return MemberService.current()}},{key:"$updateMember",value:function(member,params){return MemberService.updateMember(member,params)}},{key:"$sendWelcomeEmail",value:function(member,params){return MemberService.sendWelcomeEmail(member,params)}}]),Member_Member}(ClientModel)}),angular.module("BB.Models").factory("Member.PaymentItemModel",function(BBModel,BaseModel){return function(_BaseModel){function Member_PaymentItem(data){return _classCallCheck(this,Member_PaymentItem),_possibleConstructorReturn(this,(Member_PaymentItem.__proto__||Object.getPrototypeOf(Member_PaymentItem)).call(this,data))}return _inherits(Member_PaymentItem,_BaseModel),Member_PaymentItem}(BaseModel)}),angular.module("BB.Models").factory("Member.PrePaidBookingModel",function(BaseModel){return function(_BaseModel){function Member_PrePaidBooking(data){return _classCallCheck(this,Member_PrePaidBooking),_possibleConstructorReturn(this,(Member_PrePaidBooking.__proto__||Object.getPrototypeOf(Member_PrePaidBooking)).call(this,data))}return _inherits(Member_PrePaidBooking,_BaseModel),Member_PrePaidBooking}(BaseModel)});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();angular.module("BB.Models").factory("Member.PurchaseModel",function($q,MemberPurchaseService,BBModel,BaseModel){return function(_BaseModel){function Member_Purchase(data){_classCallCheck(this,Member_Purchase);var _this=_possibleConstructorReturn(this,(Member_Purchase.__proto__||Object.getPrototypeOf(Member_Purchase)).call(this,data));return _this.created_at=moment.parseZone(_this.created_at),_this.time_zone&&_this.created_at.tz(_this.time_zone),_this}return _inherits(Member_Purchase,_BaseModel),_createClass(Member_Purchase,[{key:"getItems",value:function(){var deferred=$q.defer();return this._data.$get("purchase_items").then(function(items){return this.items=Array.from(items).map(function(item){return new BBModel.Member.PurchaseItem(item)}),deferred.resolve(this.items)}),deferred.promise}}],[{key:"$query",value:function(member,params){return MemberPurchaseService.query(member,params)}}]),Member_Purchase}(BaseModel)}),angular.module("BB.Models").factory("Member.PurchaseItemModel",function(BBModel,BaseModel){return function(_BaseModel){function Member_PurchaseItem(data){return _classCallCheck(this,Member_PurchaseItem),_possibleConstructorReturn(this,(Member_PurchaseItem.__proto__||Object.getPrototypeOf(Member_PurchaseItem)).call(this,data))}return _inherits(Member_PurchaseItem,_BaseModel),Member_PurchaseItem}(BaseModel)});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();angular.module("BB.Models").factory("Member.WalletModel",function(WalletService,BBModel,BaseModel){return function(_BaseModel){function Member_Wallet(data){return _classCallCheck(this,Member_Wallet),_possibleConstructorReturn(this,(Member_Wallet.__proto__||Object.getPrototypeOf(Member_Wallet)).call(this,data))}return _inherits(Member_Wallet,_BaseModel),_createClass(Member_Wallet,null,[{key:"$getWalletForMember",value:function(member,params){return WalletService.getWalletForMember(member,params)}},{key:"$getWalletLogs",value:function(wallet){return WalletService.getWalletLogs(wallet)}},{key:"$getWalletPurchaseBandsForWallet",value:function(wallet){return WalletService.getWalletPurchaseBandsForWallet(wallet)}},{key:"$updateWalletForMember",value:function(member,params){return WalletService.updateWalletForMember(member,params)}},{key:"$createWalletForMember",value:function(member){return WalletService.createWalletForMember(member)}}]),Member_Wallet}(BaseModel)}),angular.module("BB.Models").factory("Member.WalletLogModel",function($q,BBModel,BaseModel){return function(_BaseModel){function Member_WalletLog(data){_classCallCheck(this,Member_WalletLog);var _this=_possibleConstructorReturn(this,(Member_WalletLog.__proto__||Object.getPrototypeOf(Member_WalletLog)).call(this,data));return _this.created_at=moment(_this.created_at),_this.payment_amount=100*parseFloat(_this.amount),_this.new_wallet_amount=100*parseFloat(_this.new_wallet_amount),_this}return _inherits(Member_WalletLog,_BaseModel),Member_WalletLog}(BaseModel)}),angular.module("BB.Models").factory("Member.WalletPurchaseBandModel",function(BBModel,BaseModel){return function(_BaseModel){function Member_WalletPurchaseBand(data){return _classCallCheck(this,Member_WalletPurchaseBand),_possibleConstructorReturn(this,(Member_WalletPurchaseBand.__proto__||Object.getPrototypeOf(Member_WalletPurchaseBand)).call(this,data))}return _inherits(Member_WalletPurchaseBand,_BaseModel),Member_WalletPurchaseBand}(BaseModel)}),angular.module("BBMember.Services").factory("MemberBookingService",function($q,SpaceCollections,$rootScope,MemberService,BBModel){return{query:function(member,params){var deferred=$q.defer();return params||(params={}),params.no_cache=!0,member.$has("bookings")?member.$get("bookings",params).then(function(bookings){var booking=void 0;return angular.isArray(bookings)?(bookings=function(){var result=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(bookings)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0)booking=_step.value,result.push(new BBModel.Member.Booking(booking))}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return result}(),deferred.resolve(bookings)):(params.no_cache=!1,bookings.$get("bookings",params).then(function(bookings){return bookings=function(){var result1=[],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(bookings)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0)booking=_step2.value,result1.push(new BBModel.Member.Booking(booking))}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return result1}(),deferred.resolve(bookings)},function(err){return deferred.reject(err)}))},function(err){return deferred.reject(err)}):deferred.reject("member does not have bookings"),deferred.promise},cancel:function(member,booking){var deferred=$q.defer();return booking.$del("self").then(function(b){return booking.deleted=!0,b=new BBModel.Member.Booking(b),BBModel.Member.Member.$refresh(member).then(function(member){return member},function(err){}),deferred.resolve(b)},function(err){return deferred.reject(err)}),deferred.promise},update:function(booking){var deferred=$q.defer();return booking.$put("self",{},booking).then(function(booking){var book=new BBModel.Member.Booking(booking);return SpaceCollections.checkItems(book),deferred.resolve(book)},function(err){return _.each(booking,function(value,key,booking){if("data"!==key&&"self"!==key)return booking[key]=booking.data[key]}),deferred.reject(err,new BBModel.Member.Booking(booking))}),deferred.promise},flush:function(member,params){if(member.$has("bookings"))return member.$flush("bookings",params)}}}),angular.module("BBMember.Services").factory("MemberLoginService",function($q,$rootScope,$sessionStorage,halClient,BBModel){return{login:function(form,options){var defer=$q.defer(),url=$rootScope.bb.api_url+"/api/v1/login";return null!=options.company_id&&(url=url+"/member/"+options.company_id),halClient.$post(url,options,form).then(function(login){return login.$has("member")?login.$get("member").then(function(member){member=new BBModel.Member.Member(member);var auth_token=member._data.getOption("auth_token");return $sessionStorage.setItem("login",member.$toStore()),$sessionStorage.setItem("auth_token",auth_token),defer.resolve(member)}):login.$has("members")?defer.resolve(login):defer.reject("No member account for login")},function(err){if(400===err.status){var login=halClient.$parse(err.data);return login.$has("members")?defer.resolve(login):defer.reject(err)}return defer.reject(err)}),defer.promise}}}),angular.module("BBMember.Services").factory("MemberService",function($q,halClient,$rootScope,BBModel){return{refresh:function(member){var deferred=$q.defer();return member.$flush("self"),member.$get("self").then(function(member){return member=new BBModel.Member.Member(member),deferred.resolve(member)},function(err){return deferred.reject(err)}),deferred.promise},current:function(){var deferred=$q.defer(),callback=function(){return deferred.resolve($rootScope.member)};return setTimeout(callback,200),deferred.promise},updateMember:function(member,params){var deferred=$q.defer();return member.$put("self",{},params).then(function(member){return member=new BBModel.Member.Member(member),deferred.resolve(member)},function(err){return deferred.reject(err)}),deferred.promise},sendWelcomeEmail:function(member,params){var deferred=$q.defer();return member.$post("send_welcome_email",params).then(function(member){return member=new BBModel.Member.Member(member),deferred.resolve(member)},function(err){return deferred.reject(err)}),deferred.promise}}}),angular.module("BBMember.Services").factory("MemberPrePaidBookingService",function($q,BBModel){return{query:function(member,params){var deferred=$q.defer();return params||(params={}),params.no_cache=!0,member.$has("pre_paid_bookings")?member.$get("pre_paid_bookings",params).then(function(bookings){var booking=void 0;return angular.isArray(bookings)?(bookings=function(){var result=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=Array.from(bookings)[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0)booking=_step.value,result.push(new BBModel.PrePaidBooking(booking))}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return result}(),deferred.resolve(bookings)):(params.no_cache=!1,bookings.$get("pre_paid_bookings",params).then(function(bookings){return bookings=function(){var result1=[],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=Array.from(bookings)[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0)booking=_step2.value,result1.push(new BBModel.PrePaidBooking(booking))}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return result1}(),deferred.resolve(bookings)}))},function(err){return deferred.reject(err)}):deferred.reject("member does not have pre paid bookings"),deferred.promise}}}),angular.module("BBMember.Services").factory("MemberPurchaseService",function($q,$rootScope,BBModel){return{query:function(member,params){params||(params={}),params.no_cache=!0;var deferred=$q.defer();return member.$has("purchase_totals")?member.$get("purchase_totals",params).then(function(purchases){return params.no_cache=!1,purchases.$get("purchase_totals",params).then(function(purchases){return purchases=Array.from(purchases).map(function(purchase){return new BBModel.PurchaseTotal(purchase)}),deferred.resolve(purchases)},function(err){return 404===err.status?deferred.resolve([]):deferred.reject(err)})},function(err){return 404===err.status?deferred.resolve([]):deferred.reject(err)}):deferred.reject("member does not have any purchases"),deferred.promise}}}),angular.module("BBMember.Services").factory("BB.Service.payment_item",function($q,BBModel,UnwrapService){return{unwrap:function(resource){return UnwrapService.unwrapResource(BBModel.Member.PaymentItem,resource)}}}),angular.module("BBMember.Services").factory("WalletService",function($q,BBModel){return{getWalletForMember:function(member,params){params||(params={}),params.no_cache=!0;var deferred=$q.defer();return member.$has("wallet")?member.$get("wallet",params).then(function(wallet){return wallet=new BBModel.Member.Wallet(wallet),deferred.resolve(wallet)},function(err){return deferred.reject(err)}):deferred.reject("Wallets are not turned on."),deferred.promise},getWalletLogs:function(wallet){var params={no_cache:!0},deferred=$q.defer();return wallet.$has("logs")?wallet.$get("logs",params).then(function(resource){return resource.$get("logs").then(function(logs){return logs=Array.from(logs).map(function(log){return new BBModel.Member.WalletLog(log)}),deferred.resolve(logs)})},function(err){return deferred.reject(err)}):deferred.reject("No wallet transactions found"),deferred.promise},getWalletPurchaseBandsForWallet:function(wallet){var deferred=$q.defer();return wallet.$has("purchase_bands")?wallet.$get("purchase_bands",{}).then(function(resource){return resource.$get("purchase_bands").then(function(bands){return bands=Array.from(bands).map(function(band){return new BBModel.Member.WalletPurchaseBand(band)}),deferred.resolve(bands)})},function(err){return deferred.reject(err)}):deferred.reject("No Purchase Bands"),deferred.promise},updateWalletForMember:function(member,params){var deferred=$q.defer();return member.$has("wallet")?member.$put("wallet",{},params).then(function(wallet){return wallet=new BBModel.Member.Wallet(wallet),deferred.resolve(wallet)},function(err){return deferred.reject(err)}):deferred.reject("Wallets are not turned on."),deferred.promise},createWalletForMember:function(member){var deferred=$q.defer(),params={};return member.$has("wallet")?member.$post("wallet",{},params).then(function(wallet){return wallet=new BBModel.Member.Wallet(wallet),deferred.resolve(wallet)},function(err){return deferred.reject(err)}):deferred.reject("Wallets are not turned on."),deferred.promise}}}),angular.module("BBMember").config(function($translateProvider){"ngInject";var translations={MEMBER:{MODAL:{EDIT_BOOKING:{CANCEL_BTN:"@:COMMON.BTN.CANCEL",SAVE_BTN:"@:COMMON.BTN.SAVE"},LOGIN:{OK_BTN:"@:COMMON.BTN.OK",CANCEL_BTN:"@:COMMON.BTN.CANCEL"},DELETE_BOOKING:{TITLE:"@:COMMON.BTN.CANCEL_BOOKING",DESCRIPTION_LBL:"@:COMMON.TERMINOLOGY.BOOKING",WHEN_LBL:"@:COMMON.TERMINOLOGY.WHEN",CANCEL_BOOKING_BTN:"@:COMMON.BTN.CANCEL_BOOKING",CANCEL_BTN:"@:COMMON.BTN.DO_NOT_CANCEL_BOOKING"},BOOKINGS_TABLE_CANCEL_BOOKING:{TITLE:"@:COMMON.BTN.CANCEL_BOOKING",EMAIL_CUSTOMER_CHECKBOX_LBL:"Email customer?",CANCEL_BOOKING_BTN:"@:COMMON.BTN.CANCEL_BOOKING",CANCEL_BTN:"@:COMMON.BTN.DO_NOT_CANCEL_BOOKING"},PICK_COMPANY:{OK_BTN:"@:COMMON.BTN.OK",CANCEL_BTN:"@:COMMON.BTN.CANCEL"},BOOKING_PAYMENT:{DESCRIPTION:"Pay for your booking to confirm your place.",TIME_RANGE:"{{start | datetime: 'LT'}} - {{end | datetime: 'LT'}}",PAY_BTN:"@:COMMON.BTN.PAY"}},LOGIN:{EMAIL_LBL:"@:COMMON.TERMINOLOGY.EMAIL",EMAIL_PLACEHOLDER:"@:COMMON.TERMINOLOGY.EMAIL",PASSWORD_LBL:"@:COMMON.FORM.PASSWORD",PASSWORD_PLACEHOLDER:"@:COMMON.FORM.PASSWORD",LOGIN_BTN:"@:COMMON.BTN.LOGIN"},MEMBER_BOOKINGS_TABLE:{DETAILS_BTN:"@:COMMON.BTN.DETAILS",CANCEL_BTN:"@:COMMON.BTN.CANCEL"},BOOKING:{TOGGLE_DROPDOWN_BTN:"Toggle Dropdown"},BOOKING_TABS:{UPCOMING_BOOKINGS_TAB_HEADING:"Upcoming bookings",PAST_BOOKINGS_TAB_HEADING:"Past bookings",PURCHASES_TAB_HEADING:"Purchases"},MEMBER_PAST_BOOKINGS:{NO_PAST_BOOKINGS:"You don't currently have any past bookings."},PAST_BOOKINGS:{HEADING:"Past Bookings"},PREPAID_BOOKINGS:{NO_PREPAID_BOOKINGS:"You don't currently have any pre-paid bookings.",REMAINING_BOOKINGS:"{{remaining}} of {{total}} remaining",PREPAID_BOOKING_DATES:"Book By {{booking.book_by | datetime: 'L'}} | Use from {{booking.use_from | datetime: 'L'}} | Use by {{booking.use_by | datetime: 'L'}}"},PURCHASES:{YOUR_PURCHASES:"Your Purchases",NO_CURRENT_PURCHASES:"You don't currently have any purchases",PURCHASE_DATE_COL_HEADING:"Purchase Date",ITEMS_COL_HEADING:"Items",TOTAL_PRICE_COL_HEADING:"Total Price",LESS_DETAIL_BTN:"@:COMMON.BTN.LESS",MORE_DETAIL_BTN:"@:COMMON.BTN.MORE"},MEMBER_UPCOMING_BOOKINGS:{NO_UPCOMING_BOOKINGS:"You don't currently have any upcoming bookings.",ON_WAITLIST_HEADING:"On Waitlist",CONFIRMED_HEADING:"Confirmed"},UPCOMING_BOOKINGS:{HEADING:"Upcoming Bookings"},PICK_COMPANY:{DESCRIPTION:"Pick Company"},WAITLIST_PAYMENT:{DESCRIPTION:"Pay for your booking to confirm your place.",PAY_BTN:"@:COMMON.BTN.PAY"},WALLET:{BALANCE_LBL:"Balance:",WALLET_NO_CREDIT:"You don't have any credit in your wallet.",STATUS_LBL:"Status:",STATUS_INACTIVE:"Your wallet is not active.",STATUS_ACTIVE:"Active",ACTIVATE_BTN:"Activate",TOP_UP_BTN:"@:COMMON.BTN.TOP_UP",AMOUNT_LBL:"Amount",PAYMENT_IFRAME_HEADING:"Make Payment",TOP_UP_WALLET_BY:"Top up wallet by {{amount | currency}}",MIN_TOP_UP:"Minimum top up amount must be greater than {{min_amount | currency}}",TOPUP_AMOUNT_PLACEHOLDER:"Enter Top Up Amount"},WALLET_LOGS:{HEADING:"Wallet Transaction History",ACTION_COL_HEADING:"Action",AMOUNT_COL_HEADING:"Amount",BALANCE_COL_HEADING:"Balance",CHANGED_BY_COL_HEADING:"Changed By",DATE_TIME_COL_HEADING:"@:COMMON.TERMINOLOGY.DATE_TIME"},WALLET_PURCHASE_BANDS:{HEADING:"Wallet Purchase Bands",$X_FOR_$Y:"{{x | currency}} for {{y | currency}}",BUY_BTN:"@:COMMON.BTN.BUY"},PURCHASE_HISTORY:{HEADING:"Purchase History"}}};$translateProvider.translations("en",translations)});