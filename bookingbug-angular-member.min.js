(function(){"use strict";angular.module("BBMember",["BB","BBMember.Directives","BBMember.Services","BBMember.Filters","BBMember.Controllers","BBMember.Models","trNgGrid","pascalprecht.translate"]),angular.module("BBMember").config(function($logProvider){return $logProvider.debugEnabled(!0)}),angular.module("BBMember").run(function(){return TrNgGrid.defaultColumnOptions={enableFiltering:!1}}),angular.module("BBMember.Directives",[]),angular.module("BBMember.Filters",[]),angular.module("BBMember.Services",["ngResource","ngSanitize","ngLocalData"]),angular.module("BBMember.Controllers",["ngLocalData","ngSanitize"]),angular.module("BBMember.Models",[]),angular.module("BBMemberMockE2E",["BBMember","BBAdminMockE2E"])}).call(this),function(){angular.module("BBMember").controller("MemberBookings",function($scope,$modal,$log,MemberBookingService,$q,ModalForm){return $scope.loading=!0,$scope.getUpcomingBookings=function(){var params;return params={start_date:moment().format("YYYY-MM-DD")},$scope.getBookings(params).then(function(bookings){return $scope.upcoming_bookings=bookings})},$scope.getPastBookings=function(num,type){var date,params;return date=moment().subtract(num,type),params={start_date:date.format("YYYY-MM-DD"),end_date:moment().format("YYYY-MM-DD")},$scope.getBookings(params).then(function(bookings){return $scope.past_bookings=bookings})},$scope.flushBookings=function(){var params;return params={start_date:moment().format("YYYY-MM-DD")},MemberBookingService.flush($scope.member,params)},$scope.edit=function(booking){return booking.getAnswersPromise().then(function(answers){var answer,i,len,ref;for(ref=answers.answers,i=0,len=ref.length;len>i;i++)answer=ref[i],booking["question"+answer.question_id]=answer.value;return ModalForm.edit({model:booking,title:"Booking Details",templateUrl:"edit_booking_modal_form.html",windowClass:"member_edit_booking_form"})})},$scope.cancel=function(booking){var modalInstance;return modalInstance=$modal.open({templateUrl:"member_booking_delete_modal.html",windowClass:"bbug",controller:function($scope,$rootScope,$modalInstance,booking){return $scope.controller="ModalDelete",$scope.booking=booking,$scope.confirm_delete=function(){return $modalInstance.close(booking)},$scope.cancel=function(){return $modalInstance.dismiss("cancel")}},resolve:{booking:function(){return booking}}}),modalInstance.result.then(function(booking){return $scope.cancelBooking(booking)})},$scope.getBookings=function(params){var defer;return $scope.loading=!0,defer=$q.defer(),MemberBookingService.query($scope.member,params).then(function(bookings){return $scope.loading=!1,defer.resolve(bookings)},function(err){return $log.error(err.data),$scope.loading=!1}),defer.promise},$scope.cancelBooking=function(booking){return $scope.loading=!0,MemberBookingService.cancel($scope.member,booking).then(function(){return $scope.bookings&&($scope.bookings=$scope.bookings.filter(function(b){return b.id!==booking.id})),$scope.removeBooking&&$scope.removeBooking(booking),$scope.loading=!1})}})}.call(this),function(){angular.module("BBMember").directive("memberBookings",function($rootScope){var link;return link=function(scope,element,attrs){var base,base1;return $rootScope.bb||($rootScope.bb={}),(base=$rootScope.bb).api_url||(base.api_url=scope.apiUrl),(base1=$rootScope.bb).api_url||(base1.api_url="http://www.bookingbug.com")},{link:link,templateUrl:"member_bookings_tabs.html",scope:{apiUrl:"@",member:"="}}})}.call(this),function(){angular.module("BBMember").directive("memberBookingsTable",function($modal,$log,$rootScope,MemberLoginService,MemberBookingService,$compile,$templateCache,ModalForm){var controller,link;return controller=function($scope,$modal){var getBookings;return $scope.loading=!0,$scope.fields||($scope.fields=["describe","full_describe"]),$scope.$watch("member",function(member){return null!=member?getBookings($scope,member):void 0}),$scope.edit=function(id){var booking;return booking=_.find($scope.booking_models,function(b){return b.id===id}),booking.getAnswersPromise().then(function(answers){var answer,i,len,ref;for(ref=answers.answers,i=0,len=ref.length;len>i;i++)answer=ref[i],booking["question"+answer.question_id]=answer.value;return ModalForm.edit({model:booking,title:"Booking Details",templateUrl:"edit_booking_modal_form.html"})})},getBookings=function($scope,member){var params;return params={start_date:moment().format("YYYY-MM-DD")},MemberBookingService.query(member,params).then(function(bookings){return $scope.booking_models=bookings,$scope.bookings=_.map(bookings,function(booking){return _.pick(booking,"id","full_describe","describe")}),$scope.loading=!1},function(err){return $log.error(err.data),$scope.loading=!1})}},link=function(scope,element,attrs){var base,base1;return $rootScope.bb||($rootScope.bb={}),(base=$rootScope.bb).api_url||(base.api_url=scope.apiUrl),(base1=$rootScope.bb).api_url||(base1.api_url="http://www.bookingbug.com")},{link:link,controller:controller,templateUrl:"member_bookings_table.html",scope:{apiUrl:"@",fields:"=?",member:"="}}})}.call(this),function(){angular.module("BBMember").directive("memberForm",function($modal,$log,$rootScope,MemberLoginService,MemberBookingService){var controller,link;return controller=function($scope){return $scope.loading=!0,$scope.$watch("member",function(member){return null!=member?member.$get("edit_member").then(function(member_schema){return $scope.form=member_schema.form,$scope.schema=member_schema.schema,$scope.loading=!1}):void 0}),$scope.submit=function(form){return $scope.loading=!0,$scope.member.$put("self",{},form).then(function(member){return $log.info("Successfully updated member"),$scope.loading=!1},function(err){return $log.error("Failed to update member - "+err),$scope.loading=!1})}},link=function(scope,element,attrs){var base,base1;return $rootScope.bb||($rootScope.bb={}),(base=$rootScope.bb).api_url||(base.api_url=attrs.apiUrl),(base1=$rootScope.bb).api_url||(base1.api_url="http://www.bookingbug.com")},{link:link,controller:controller,template:'<form sf-schema="schema" sf-form="form" sf-model="member"\n  ng-submit="submit(member)" ng-hide="loading"></form>'}})}.call(this),function(){angular.module("BBMember").directive("loginMember",function($modal,$log,$rootScope,MemberLoginService,$templateCache,$q){var link,loginMemberController,pickCompanyController;return loginMemberController=function($scope,$modalInstance,company_id){return $scope.title="Login",$scope.schema={type:"object",properties:{email:{type:"string",title:"Email"},password:{type:"string",title:"Password"}}},$scope.form=[{key:"email",type:"email",feedback:!1,autofocus:!0},{key:"password",type:"password",feedback:!1}],$scope.login_form={},$scope.submit=function(form){var options;return options={company_id:company_id},MemberLoginService.login(form,options).then(function(member){return member.email=form.email,member.password=form.password,$modalInstance.close(member)},function(err){return $modalInstance.dismiss(err)})},$scope.cancel=function(){return $modalInstance.dismiss("cancel")}},pickCompanyController=function($scope,$modalInstance,companies){var c;return $scope.title="Pick Company",$scope.schema={type:"object",properties:{company_id:{type:"integer",title:"Company"}}},$scope.schema.properties.company_id["enum"]=function(){var i,len,results;for(results=[],i=0,len=companies.length;len>i;i++)c=companies[i],results.push(c.id);return results}(),$scope.form=[{key:"company_id",type:"select",titleMap:function(){var i,len,results;for(results=[],i=0,len=companies.length;len>i;i++)c=companies[i],results.push({value:c.id,name:c.name});return results}(),autofocus:!0}],$scope.pick_company_form={},$scope.submit=function(form){return $modalInstance.close(form.company_id)},$scope.cancel=function(){return $modalInstance.dismiss("cancel")}},link=function(scope,element,attrs){var base,base1,loginModal,pickCompanyModal,tryLogin;return $rootScope.bb||($rootScope.bb={}),(base=$rootScope.bb).api_url||(base.api_url=scope.apiUrl),(base1=$rootScope.bb).api_url||(base1.api_url="http://www.bookingbug.com"),loginModal=function(){var modalInstance;return modalInstance=$modal.open({templateUrl:"login_modal_form.html",controller:loginMemberController,resolve:{company_id:function(){return scope.companyId}}}),modalInstance.result.then(function(result){return scope.memberEmail=result.email,scope.memberPassword=result.password,result.$has("members")?result.$get("members").then(function(members){var m;return scope.members=members,$q.all(function(){var i,len,results;for(results=[],i=0,len=members.length;len>i;i++)m=members[i],results.push(m.$get("company"));return results}()).then(function(companies){return pickCompanyModal(companies)})}):scope.member=result},function(){return loginModal()})},pickCompanyModal=function(companies){var modalInstance;return modalInstance=$modal.open({templateUrl:"pick_company_modal_form.html",controller:pickCompanyController,resolve:{companies:function(){return companies}}}),modalInstance.result.then(function(company_id){return scope.companyId=company_id,tryLogin()},function(){return pickCompanyModal()})},tryLogin=function(){var login_form,options;return login_form={email:scope.memberEmail,password:scope.memberPassword},options={company_id:scope.companyId},MemberLoginService.login(login_form,options).then(function(result){return result.$has("members")?result.$get("members").then(function(members){var m;return scope.members=members,$q.all(function(){var i,len,results;for(results=[],i=0,len=members.length;len>i;i++)m=members[i],results.push(m.$get("company"));return results}()).then(function(companies){return pickCompanyModal(companies)})}):scope.member=result},function(err){return loginModal()})},scope.memberEmail&&scope.memberPassword?tryLogin():loginModal()},{link:link,scope:{memberEmail:"@",memberPassword:"@",companyId:"@",apiUrl:"@",member:"="},transclude:!0,template:"<div ng-show='member' ng-transclude></div>"}})}.call(this),function(){angular.module("BBMember").directive("bbMemberPastBookings",function($rootScope){var link;return link=function(scope,element,attrs){var base,base1,getBookings;return $rootScope.bb||($rootScope.bb={}),(base=$rootScope.bb).api_url||(base.api_url=scope.apiUrl),(base1=$rootScope.bb).api_url||(base1.api_url="http://www.bookingbug.com"),(getBookings=function(){return scope.getPastBookings()})()},{link:link,controller:"MemberBookings",templateUrl:"member_past_bookings.html",scope:{apiUrl:"@",member:"="}}})}.call(this),function(){angular.module("BBMember").directive("memberSsoLogin",function($rootScope,LoginService,$sniffer,$timeout){var link;return link=function(scope,element,attrs){var base,base1,data,options;return $rootScope.bb||($rootScope.bb={}),(base=$rootScope.bb).api_url||(base.api_url=scope.apiUrl),(base1=$rootScope.bb).api_url||(base1.api_url="http://www.bookingbug.com"),scope.member=null,options={root:$rootScope.bb.api_url,company_id:scope.companyId},data={token:scope.token},$sniffer.msie&&$sniffer.msie<10&&$rootScope.iframe_proxy_ready===!1?$timeout(function(){return LoginService.ssoLogin(options,data).then(function(member){return scope.member=member})},2e3):LoginService.ssoLogin(options,data).then(function(member){return scope.member=member})},{link:link,scope:{token:"@memberSsoLogin",companyId:"@",apiUrl:"@",member:"="},transclude:!0,template:"<div ng-if='member' ng-transclude></div>"}})}.call(this),function(){angular.module("BBMember").directive("bbMemberUpcomingBookings",function($rootScope){var link;return link=function(scope,element,attrs){var base,base1,getBookings;return $rootScope.bb||($rootScope.bb={}),(base=$rootScope.bb).api_url||(base.api_url=scope.apiUrl),(base1=$rootScope.bb).api_url||(base1.api_url="http://www.bookingbug.com"),getBookings=function(){return scope.getUpcomingBookings()},scope.$on("updateBookings",function(){return scope.flushBookings(),getBookings()}),getBookings()},{link:link,controller:"MemberBookings",templateUrl:"member_upcoming_bookings.html",scope:{apiUrl:"@",member:"="}}})}.call(this),function(){angular.module("BB.Services").factory("MemberBookingService",function($q,SpaceCollections,$rootScope,MemberService,BBModel){return{query:function(member,params){var deferred;return deferred=$q.defer(),member.$has("bookings")?member.$get("bookings",params).then(function(_this){return function(bookings){var booking;return angular.isArray(bookings)?(bookings=function(){var i,len,results;for(results=[],i=0,len=bookings.length;len>i;i++)booking=bookings[i],results.push(new BBModel.Member.Booking(booking));return results}(),deferred.resolve(bookings)):bookings.$get("bookings",params).then(function(bookings){return bookings=function(){var i,len,results;for(results=[],i=0,len=bookings.length;len>i;i++)booking=bookings[i],results.push(new BBModel.Member.Booking(booking));return results}(),deferred.resolve(bookings)},function(err){return deferred.reject(err)})}}(this),function(err){return deferred.reject(err)}):deferred.reject("member does not have bookings"),deferred.promise},cancel:function(member,booking){var deferred;return deferred=$q.defer(),booking.$del("self").then(function(_this){return function(b){return booking.deleted=!0,b=new BBModel.Member.Booking(b),MemberService.refresh(member).then(function(member){return member=member},function(err){}),deferred.resolve(b)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise},update:function(booking){var deferred;return deferred=$q.defer(),$rootScope.member.flushBookings(),booking.$put("self",{},booking).then(function(_this){return function(booking){var book;return book=new BBModel.Member.Booking(booking),SpaceCollections.checkItems(book),deferred.resolve(book)}}(this),function(_this){return function(err){return _.each(booking,function(value,key,booking){return"data"!==key&&"self"!==key?booking[key]=booking.data[key]:void 0}),deferred.reject(err,new BBModel.Member.Booking(booking))}}(this)),deferred.promise},flush:function(member,params){return member.$has("bookings")?member.$flush("bookings",params):void 0}}})}.call(this),function(){angular.module("BBMember.Services").factory("MemberLoginService",function($q,halClient,$rootScope,BBModel){return{login:function(form,options){var defer,url;return defer=$q.defer(),url=$rootScope.bb.api_url+"/api/v1/login",null!=options.company_id&&(url=url+"/member/"+options.company_id),halClient.$post(url,options,form).then(function(login){return login.$has("member")?login.$get("member").then(function(member){return member=new BBModel.Member.Member(member),defer.resolve(member)}):login.$has("members")?defer.resolve(login):defer.reject("No member account for login")},function(_this){return function(err){var login;return 400===err.status?(login=halClient.$parse(err.data),login.$has("members")?defer.resolve(login):defer.reject(err)):defer.reject(err)}}(this)),defer.promise}}})}.call(this),function(){angular.module("BB.Services").factory("MemberService",function($q,halClient,$rootScope,BBModel){return{refresh:function(member){var deferred;return deferred=$q.defer(),member.$flush("self"),member.$get("self").then(function(_this){return function(member){return member=new BBModel.Member.Member(member),deferred.resolve(member)}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)),deferred.promise},current:function(){var callback,deferred;return deferred=$q.defer(),callback=function(){return deferred.resolve($rootScope.member)},setTimeout(callback,200),deferred.promise}}})}.call(this),function(){angular.module("BB.Services").factory("MemberPrePaidBookingService",function($q,$window,SpaceCollections,$rootScope,MemberService){return{query:function(member,params){var deferred;return deferred=$q.defer(),member.$has("pre_paid_bookings")?member.$get("pre_paid_bookings",params).then(function(_this){return function(bookings){var booking;return $window.typeIsArray(bookings)?(bookings=function(){var i,len,results;for(results=[],i=0,len=bookings.length;len>i;i++)booking=bookings[i],results.push(new BBModel.Member.PrePaidBooking(booking));return results}(),deferred.resolve(bookings)):bookings.$get("pre_paid_bookings",params).then(function(bookings){return bookings=function(){var i,len,results;for(results=[],i=0,len=bookings.length;len>i;i++)booking=bookings[i],results.push(new BBModel.Member.PrePaidBooking(booking));return results}(),deferred.resolve(bookings)})}}(this),function(_this){return function(err){return deferred.reject(err)}}(this)):deferred.reject("member does not have pre paid bookings"),deferred.promise}}})}.call(this),function(){"use strict";var bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("Member.BookingModel",function($q,$window,BBModel,BaseModel,$bbug){var Member_Booking;return Member_Booking=function(superClass){function Member_Booking(data){this.getMemberPromise=bind(this.getMemberPromise,this),Member_Booking.__super__.constructor.call(this,data),this.datetime=moment.parseZone(this.datetime),this.time_zone&&this.datetime.tz(this.time_zone),this.end_datetime=moment.parseZone(this.end_datetime),this.time_zone&&this.end_datetime.tz(this.time_zone)}return extend(Member_Booking,superClass),Member_Booking.prototype.getGroup=function(){return this.group?this.group:this._data.$has("event_groups")?this._data.$get("event_groups").then(function(_this){return function(group){return _this.group=group,_this.group}}(this)):void 0},Member_Booking.prototype.getColour=function(){return this.getGroup()?this.getGroup().colour:"#FFFFFF"},Member_Booking.prototype.getCompany=function(){return this.company?this.company:this.$has("company")?this._data.$get("company").then(function(_this){return function(company){return _this.company=new BBModel.Company(company),_this.company}}(this)):void 0},Member_Booking.prototype.getAnswers=function(){var defer;return defer=$q.defer(),this.answers&&defer.resolve(this.answers),this._data.$has("answers")?this._data.$get("answers").then(function(_this){return function(answers){var a;return _this.answers=function(){var i,len,results;for(results=[],i=0,len=answers.length;len>i;i++)a=answers[i],results.push(new BBModel.Answer(a));return results}(),defer.resolve(_this.answers)}}(this)):defer.resolve([]),defer.promise},Member_Booking.prototype.printed_price=function(){return parseFloat(this.price)%1===0?"£"+this.price:$window.sprintf("£%.2f",parseFloat(this.price))},Member_Booking.prototype.getMemberPromise=function(){var defer;return defer=$q.defer(),this.member&&defer.resolve(this.member),this._data.$has("member")&&this._data.$get("member").then(function(_this){return function(member){return _this.member=new BBModel.Member.Member(member),defer.resolve(_this.member)}}(this)),defer.promise},Member_Booking.prototype.canCancel=function(){return moment(this.min_cancellation_time).isAfter(moment())},Member_Booking.prototype.canMove=function(){return this.canCancel()},Member_Booking}(BaseModel)})}.call(this),function(){var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("Member.MemberModel",function($q,BBModel,BaseModel,ClientModel){var Member_Member;return Member_Member=function(superClass){function Member_Member(){return Member_Member.__super__.constructor.apply(this,arguments)}return extend(Member_Member,superClass),Member_Member}(ClientModel)})}.call(this),function(){"use strict";var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;angular.module("BB.Models").factory("Member.PrepaidBookingModel",function($q,BBModel,BaseModel){var Member_PrePaidBooking;return Member_PrePaidBooking=function(superClass){function Member_PrePaidBooking(data){Member_PrePaidBooking.__super__.constructor.call(this,data)}return extend(Member_PrePaidBooking,superClass),Member_PrePaidBooking.prototype.checkValidity=function(event){return this.service_id&&event.service_id&&this.service_id!==event.service_id?!1:this.resource_id&&event.resource_id&&this.resource_id!==event.resource_id?!1:this.person_id&&event.person_id&&this.person_id!==event.person_id?!1:!0},Member_PrePaidBooking}(BaseModel)})}.call(this);